<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive NV Simulator</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #ffffff;
            color: #000000;
        }
        
        .container {
            max-width: 100%;
            height: 100vh;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: #000000;
            color: #ffffff;
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-header {
            padding: 15px 20px;
            border-bottom: 1px solid #333333;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 500;
        }
        
        .sidebar-nav {
            padding: 0;
        }
        
        .nav-section {
            margin-bottom: 20px;
        }
        
        .nav-section-title {
            padding: 15px 20px 10px 20px;
            font-size: 0.9em;
            color: #cccccc;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .nav-item {
            display: block;
            padding: 12px 20px;
            color: #ffffff;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 1em;
        }
        
        .nav-item:hover {
            background-color: #333333;
        }
        
        .nav-item.active {
            background-color: #ffffff;
            color: #000000;
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        
        .header {
            background: #000000;
            color: #ffffff;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #cccccc;
            height: 50px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .menu-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            margin-right: 15px;
            padding: 2px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .menu-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .menu-icon span {
            display: block;
            width: 20px;
            height: 2px;
            background: #ffffff;
            margin: 3px 0;
            border-radius: 1px;
            transition: all 0.3s ease;
        }
        
        .header-right {
            text-align: right;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 300;
        }
        
        .header p {
            margin: 2px 0 0 0;
            opacity: 0.8;
            font-size: 0.8em;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #cccccc;
            display: none;
        }
        
        .controls.show {
            display: block;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #000000;
        }
        
        .btn {
            background: #000000;
            color: #ffffff;
            border: 2px solid #000000;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #ffffff;
            color: #000000;
        }
        
        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        input[type="number"] {
            padding: 8px;
            border: 2px solid #cccccc;
            border-radius: 4px;
            width: 80px;
            text-align: center;
            font-weight: 600;
            background: #ffffff;
            color: #000000;
        }
        
        .page-content {
            display: none;
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .page-content.active {
            display: block;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: #f8f9fa;
            border: 2px solid #cccccc;
            border-radius: 8px;
            padding: 20px;
        }
        
        .dashboard-card h3 {
            margin: 0 0 15px 0;
            color: #000000;
        }
        
        .dashboard-actions {
            margin-top: 30px;
            text-align: center;
        }
        
        .dashboard-actions .btn {
            margin: 0 10px;
        }
        
        .status {
            background: #f8f9fa;
            border: 2px solid #cccccc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status h3 {
            margin: 0 0 15px 0;
            color: #000000;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            background: #ffffff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #cccccc;
        }
        
        .status-item strong {
            color: #000000;
        }
        
        .physics-info {
            background: #f8f9fa;
            border: 2px solid #cccccc;
            border-radius: 8px;
            padding: 20px;
        }
        
        .physics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .physics-item {
            background: #ffffff;
            border: 1px solid #cccccc;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        
        .plot-container {
            background: #f8f9fa;
            border: 2px solid #cccccc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .plot-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 75vh;
        }
        
        .plot-section {
            background: #ffffff;
            border: 1px solid #cccccc;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .plot-section h3 {
            margin: 0 0 15px 0;
            color: #000000;
            text-align: center;
            font-size: 1.1em;
        }
        
        .plot-section .loading {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .plot-section #pulse-plot,
        .plot-section #rabi-plot {
            flex: 1;
            min-height: 0;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #000000;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #cccccc;
            border-top: 4px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 8px 15px;
            }
            
            .header h1 {
                font-size: 1.2em;
            }
            
            .header p {
                font-size: 0.7em;
            }
            
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: center;
            }
            
            .status-grid, .physics-grid {
                grid-template-columns: 1fr;
            }
            
            .plot-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .plot-section {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Navigation</h3>
        </div>
        <div class="sidebar-nav">
            <div class="nav-section">
                <button class="nav-item active" onclick="showPage('dashboard')">Dashboard</button>
                <button class="nav-item" onclick="showPage('parameters')">Parameters</button>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Experimente</div>
                <button class="nav-item" onclick="showPage('rabi')">Rabi Oszillation</button>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Auswertung</div>
                <button class="nav-item" onclick="showPage('auswertung')">Rabi Oszillation</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="menu-icon" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="header-right">
                <h1>Interactive NV Simulator</h1>
                <p>HYPERREALISTIC: Phonon-Coupling + Time-dependent MW Pulses + All Advanced Physics</p>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>MW Pulse Duration:</label>
                    <span id="current-tau" style="font-weight: bold; font-size: 1.2em;">0 ns</span>
                </div>
                
                <button class="btn" onclick="prevTau()">Previous</button>
                <button class="btn" onclick="nextTau()">Next</button>
                <button class="btn" onclick="jumpToAngle(90)">π/2 Pulse</button>
                <button class="btn" onclick="jumpToAngle(180)">π Pulse</button>
                <button class="btn" onclick="resetTau()">Reset</button>
            </div>
            
            <div class="control-row">
                <div class="control-group">
                    <label>Integration Window:</label>
                    <input type="number" id="start-time" value="0" min="0" max="3000">
                    <span>to</span>
                    <input type="number" id="end-time" value="1000" min="0" max="3000">
                    <span>ns</span>
                    <button class="btn" onclick="updatePlots()">Update</button>
                </div>
                
                <button class="btn" onclick="simulateAll()" id="simulate-btn">
                    Start Full Simulation
                </button>
            </div>
        </div>
        
        <!-- Dashboard Page -->
        <div id="dashboard-content" class="page-content active">
            <h2>Dashboard</h2>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>Current Status</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <strong>ms=0 Population:</strong> <span id="p-ms0">--</span>
                        </div>
                        <div class="status-item">
                            <strong>ms=±1 Population:</strong> <span id="p-ms1">--</span>
                        </div>
                        <div class="status-item">
                            <strong>Rabi Angle:</strong> <span id="rabi-angle">--</span>
                        </div>
                        <div class="status-item">
                            <strong>Simulation Points:</strong> <span id="sim-points">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3>Key Parameters</h3>
                    <div id="key-parameters">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="dashboard-actions">
                <button class="btn" onclick="simulateAll()" id="simulate-btn">
                    Start Full Simulation
                </button>
                <button class="btn" onclick="updatePlots()">
                    Update Plots
                </button>
            </div>
        </div>
        
        <!-- Parameters Page -->
        <div id="parameters-content" class="page-content">
            <h2>Physics Parameters</h2>
            <div class="physics-info">
                <div class="physics-grid" id="physics-grid">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Rabi Oscillation Page -->
        <div id="rabi-content" class="page-content">
            <h2>Rabi Oszillation</h2>
            <div class="plot-container">
                <div class="plot-grid">
                    <div class="plot-section">
                        <h3>Pulse Timeline</h3>
                        <div class="loading" id="pulse-loading">
                            <div class="loading-spinner"></div>
                            <p>Ready for simulation...</p>
                        </div>
                        <div id="pulse-plot"></div>
                    </div>
                    
                    <div class="plot-section">
                        <h3>Rabi Oscillation</h3>
                        <div class="loading" id="rabi-loading">
                            <div class="loading-spinner"></div>
                            <p>Ready for simulation...</p>
                        </div>
                        <div id="rabi-plot"></div>
                    </div>
                </div>
            </div>
            
            <!-- Emission Spectrum Plot (below pulse plot) -->
            <div class="plot-container" style="margin-top: 20px;">
                <div class="plot-section">
                    <h3>NV Emission Spectrum</h3>
                    <div class="loading" id="spectrum-loading">
                        <div class="loading-spinner"></div>
                        <p>Ready for simulation...</p>
                    </div>
                    <div id="spectrum-plot"></div>
                </div>
            </div>
        </div>
        
        <!-- Auswertung Page -->
        <div id="auswertung-content" class="page-content">
            <h2>Auswertung - Rabi Oszillation</h2>
            
            <div class="dashboard-card" style="margin-bottom: 20px;">
                <h3>Datenquelle wählen</h3>
                <div class="control-row">
                    <button class="btn" onclick="loadSampleData()" style="margin-right: 10px;">Beispieldaten laden</button>
                    <button class="btn" onclick="toggleFileUpload()">Eigene Dateien hochladen</button>
                </div>
                
                <div class="control-row" style="border-top: 1px solid #ccc; padding-top: 15px; margin-top: 15px;">
                    <div class="control-group">
                        <label>Zeitfenster für Rabi-Analyse:</label>
                        <input type="number" id="auswertung-start-time" value="0" min="0" max="3000" style="width: 60px;">
                        <span>bis</span>
                        <input type="number" id="auswertung-end-time" value="100" min="0" max="3000" style="width: 60px;">
                        <span>ns</span>
                        <button class="btn" onclick="updateAuswertungRabi()" style="margin-left: 10px;">Rabi aktualisieren</button>
                    </div>
                </div>
                
                <div id="file-upload-section" style="display: none; margin-top: 15px; border-top: 1px solid #ccc; padding-top: 15px;">
                    <div class="control-row">
                        <div class="control-group">
                            <label>Datei 1:</label>
                            <input type="file" id="file1" accept=".dat" style="margin-left: 10px;">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Datei 2:</label>
                            <input type="file" id="file2" accept=".dat" style="margin-left: 10px;">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Datei 3:</label>
                            <input type="file" id="file3" accept=".dat" style="margin-left: 10px;">
                        </div>
                    </div>
                    <div class="control-row">
                        <button class="btn" onclick="uploadAndAnalyze()">Eigene Daten analysieren</button>
                    </div>
                </div>
            </div>
            
            <div class="plot-container">
                <div class="plot-grid">
                    <div class="plot-section">
                        <h3>Übersicht</h3>
                        <div class="loading" id="experimental-loading" style="display: flex;">
                            <div class="loading-spinner"></div>
                            <p>Lade Dateien hoch und klicke 'Daten analysieren'...</p>
                        </div>
                        <div id="experimental-plot" style="display: none;"></div>
                    </div>
                    
                    <div class="plot-section">
                        <h3>Rabi Oszillation</h3>
                        <div class="loading" id="experimental-rabi-loading" style="display: flex;">
                            <div class="loading-spinner"></div>
                            <p>Warte auf Datenanalyse...</p>
                        </div>
                        <div id="experimental-rabi-plot" style="display: none;"></div>
                    </div>
                </div>
            </div>
            
            <div class="plot-container">
                <div class="plot-grid">
                    <div class="plot-section">
                        <h3>Einzelner Puls</h3>
                        <div style="text-align: center; margin-bottom: 10px;">
                            <button class="btn" onclick="prevPulse()" style="margin-right: 10px;">← Vorheriger</button>
                            <span id="pulse-counter" style="font-weight: bold;">Puls 1 / --</span>
                            <button class="btn" onclick="nextPulse()" style="margin-left: 10px;">Nächster →</button>
                        </div>
                        <div class="loading" id="single-pulse-loading" style="display: flex;">
                            <div class="loading-spinner"></div>
                            <p>Warte auf Datenanalyse...</p>
                        </div>
                        <div id="single-pulse-plot" style="display: none;"></div>
                    </div>
                    
                    <div class="plot-section">
                        <!-- Placeholder for second plot if needed -->
                    </div>
                </div>
            </div>
            
            <!-- Raw Data Plot (Full Width) -->
            <div class="plot-container" style="margin-top: 20px;">
                <h2 style="text-align: center; margin-bottom: 15px;">Raw</h2>
                <div style="background: #ffffff; border: 1px solid #cccccc; border-radius: 6px; padding: 15px; height: 60vh;">
                    <div class="loading" id="raw-loading" style="display: flex; height: 100%;">
                        <div class="loading-spinner"></div>
                        <p>Warte auf Datenanalyse...</p>
                    </div>
                    <div id="raw-plot" style="display: none; height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTau = 0;
        let tauList = [];
        let isSimulated = false;
        let physicsInfo = {};
        
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }
        
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(`${pageName}-content`).classList.add('active');
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide controls based on page
            const controls = document.querySelector('.controls');
            if (pageName === 'rabi') {
                controls.classList.add('show');
            } else {
                controls.classList.remove('show');
            }
            
            // Auto-load sample data when opening Auswertung page
            if (pageName === 'auswertung') {
                loadSampleDataAutomatically();
            }
            
            // Close sidebar
            closeSidebar();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadPhysicsInfo();
            generateTauList();
            updateCurrentTau();
        });
        
        function generateTauList() {
            tauList = [];
            // Much more pulse values with finer resolution
            for (let i = 0; i <= 500; i += 10) {
                tauList.push(i);
            }
        }
        
        async function loadPhysicsInfo() {
            try {
                const response = await fetch('/api/physics_info');
                physicsInfo = await response.json();
                displayPhysicsInfo();
            } catch (error) {
                console.error('Error loading physics info:', error);
            }
        }
        
        function displayPhysicsInfo() {
            const grid = document.getElementById('physics-grid');
            
            // Populate main physics grid
            grid.innerHTML = `
                <div class="physics-item">
                    <strong>DW Factor</strong><br>${physicsInfo.DW_factor}
                </div>
                <div class="physics-item">
                    <strong>T₁</strong><br>${physicsInfo.T1_ms} ms
                </div>
                <div class="physics-item">
                    <strong>T₂*</strong><br>${physicsInfo.T2_star_us} μs
                </div>
                <div class="physics-item">
                    <strong>ISC ms=±1</strong><br>${physicsInfo.gamma_ISC_ms1_MHz} MHz
                </div>
                <div class="physics-item">
                    <strong>ISC ms=0</strong><br>${physicsInfo.gamma_ISC_ms0_MHz} MHz
                </div>
                <div class="physics-item">
                    <strong>Dead Time</strong><br>${physicsInfo.dead_time_ns} ns
                </div>
                <div class="physics-item">
                    <strong>Rabi Freq</strong><br>${(physicsInfo.Omega_Rabi_Hz/1e6).toFixed(1)} MHz
                </div>
                <div class="physics-item">
                    <strong>Readout</strong><br>${physicsInfo.READ_NS} ns
                </div>
                <div class="physics-item">
                    <strong>¹³C Bath</strong><br>${physicsInfo.n_carbon13} nuclei
                </div>
                <div class="physics-item">
                    <strong>¹⁴N Bath</strong><br>${physicsInfo.n_nitrogen14} nuclei
                </div>
                <div class="physics-item">
                    <strong>D (GS)</strong><br>${physicsInfo.D_GS_Hz.toFixed(2)} GHz
                </div>
                <div class="physics-item">
                    <strong>D (ES)</strong><br>${physicsInfo.D_ES_Hz.toFixed(2)} GHz
                </div>
                <div class="physics-item">
                    <strong>B-Field</strong><br>${physicsInfo.B_field_mT[2].toFixed(1)} mT
                </div>
                <div class="physics-item">
                    <strong>g-Factor</strong><br>${physicsInfo.g_e}
                </div>
                <div class="physics-item">
                    <strong>Strain σ</strong><br>${physicsInfo.strain_sigma_MHz} MHz
                </div>
                <div class="physics-item">
                    <strong>Orbital γ</strong><br>${physicsInfo.gamma_orbital_MHz} MHz
                </div>
                <div class="physics-item">
                    <strong>Temperature</strong><br>${physicsInfo.Temperature_K} K
                </div>
                <div class="physics-item">
                    <strong>T₁ (GS)</strong><br>${physicsInfo.T1_GS_ms} ms
                </div>
                <div class="physics-item">
                    <strong>T₂ (GS)</strong><br>${physicsInfo.T2_GS_us} μs
                </div>
                <div class="physics-item">
                    <strong>ISC E₀</strong><br>${physicsInfo.ISC_ms0_activation_meV} meV
                </div>
                <div class="physics-item">
                    <strong>ISC E₁</strong><br>${physicsInfo.ISC_ms1_activation_meV} meV
                </div>
                <div class="physics-item">
                    <strong>Ion (GS)</strong><br>${physicsInfo.ionization_rate_GS_MHz} MHz
                </div>
                <div class="physics-item">
                    <strong>Ion (ES)</strong><br>${physicsInfo.ionization_rate_ES_MHz} MHz
                </div>
                <div class="physics-item">
                    <strong>Recombi</strong><br>${physicsInfo.recombination_rate_MHz} MHz
                </div>
                <div class="physics-item">
                    <strong>Laser P</strong><br>${physicsInfo.laser_power_mW} mW
                </div>
                <div class="physics-item">
                    <strong>λ Laser</strong><br>${physicsInfo.laser_wavelength_nm} nm
                </div>
                <div class="physics-item">
                    <strong>Δν Laser</strong><br>${physicsInfo.laser_linewidth_GHz} GHz
                </div>
                <div class="physics-item">
                    <strong>DW₀ (T=0)</strong><br>${physicsInfo.DW0_at_zero_K} 
                </div>
                <div class="physics-item">
                    <strong>θ_D</strong><br>${physicsInfo.theta_D_K} K
                </div>
                <div class="physics-item">
                    <strong>DW α</strong><br>${physicsInfo.debye_waller_alpha}
                </div>
                <div class="physics-item">
                    <strong>γ_rad</strong><br>${physicsInfo.gamma_rad_MHz} MHz
                </div>
                <div class="physics-item">
                    <strong>k_orb(300K)</strong><br>${physicsInfo.k_orb_300K_MHz} MHz
                </div>
                <div class="physics-item">
                    <strong>k_orb E_a</strong><br>${physicsInfo.k_orb_activation_K} K
                </div>
                <div class="physics-item">
                    <strong>MW Shape</strong><br>${physicsInfo.mw_pulse_shape}
                </div>
                <div class="physics-item">
                    <strong>MW σ</strong><br>${physicsInfo.mw_sigma_ns} ns
                </div>
                <div class="physics-item">
                    <strong>MW Amp Noise</strong><br>${physicsInfo.mw_amplitude_noise_std}
                </div>
                <div class="physics-item">
                    <strong>MW Phase Noise</strong><br>${physicsInfo.mw_phase_noise_std} rad
                </div>
                <div class="physics-item">
                    <strong>MW Freq Drift</strong><br>${physicsInfo.mw_frequency_drift_Hz} Hz
                </div>
                <div class="physics-item">
                    <strong>MW Inhomogeneity</strong><br>${physicsInfo.mw_inhomogeneity}
                </div>
            `;
            
            // Populate dashboard key parameters
            const keyParams = document.getElementById('key-parameters');
            keyParams.innerHTML = `
                <div class="status-grid">
                    <div class="status-item">
                        <strong>Rabi Freq:</strong> ${(physicsInfo.Omega_Rabi_Hz/1e6).toFixed(1)} MHz
                    </div>
                    <div class="status-item">
                        <strong>Temperature:</strong> ${physicsInfo.Temperature_K} K
                    </div>
                    <div class="status-item">
                        <strong>Collection:</strong> ${(physicsInfo.collection_efficiency*100).toFixed(1)}%
                    </div>
                    <div class="status-item">
                        <strong>Shots:</strong> ${physicsInfo.Shots.toLocaleString()}
                    </div>
                    <div class="status-item">
                        <strong>T₁:</strong> ${physicsInfo.T1_ms} ms
                    </div>
                    <div class="status-item">
                        <strong>T₂*:</strong> ${physicsInfo.T2_star_us} μs
                    </div>
                </div>
            `;
        }
        
        async function simulateAll() {
            const btn = document.getElementById('simulate-btn');
            btn.disabled = true;
            btn.innerHTML = 'Simulating...';
            
            document.getElementById('pulse-loading').innerHTML = `
                <div class="loading-spinner"></div>
                <p>Running full tau sweep simulation...</p>
            `;
            
            try {
                const response = await fetch('/api/simulate_tau_sweep');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                isSimulated = true;
                document.getElementById('status-section').style.display = 'block';
                document.getElementById('sim-points').textContent = Object.keys(result).length;
                
                btn.innerHTML = 'Simulation Complete';
                btn.disabled = false;
                
                // Load initial plots
                updateCurrentTau();
                updatePlots();
            } catch (error) {
                console.error('Simulation error:', error);
                btn.innerHTML = 'Simulation Failed';
                btn.disabled = false;
            }
        }
        
        function updateCurrentTau() {
            document.getElementById('current-tau').textContent = `${currentTau} ns`;
            
            if (isSimulated && physicsInfo.Omega_Rabi_Hz) {
                const rabiAngle = physicsInfo.Omega_Rabi_Hz * currentTau * 1e-9 * 180 / Math.PI;
                document.getElementById('rabi-angle').textContent = `${rabiAngle.toFixed(1)}°`;
            }
        }
        
        async function updatePlots() {
            if (!isSimulated) {
                console.log('Simulation not yet completed, skipping plot updates');
                return;
            }
            
            try {
                // Update pulse plot
                await updatePulsePlot();
                
                // Update Rabi plot
                await updateRabiPlot();
                
                // Update emission spectrum
                await updateEmissionSpectrum();
            } catch (error) {
                console.error('Error updating plots:', error);
            }
        }
        
        async function updatePulsePlot() {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            
            document.getElementById('pulse-loading').style.display = 'flex';
            document.getElementById('pulse-plot').style.display = 'none';
            
            try {
                const response = await fetch(`/api/pulse_plot/${currentTau}?start=${startTime}&end=${endTime}`);
                const result = await response.json();
                
                // Create plot data
                const plotData = [{
                    x: result.time_ns,
                    y: result.counts,
                    type: 'scatter',
                    mode: 'lines',
                    line: {color: '#000000', width: 2},
                    name: 'Photon Counts'
                }];
                
                const layout = {
                    title: {
                        text: `Pulse τ=${result.tau_ns}ns`,
                        font: {color: '#000000', size: 14}
                    },
                    xaxis: {
                        title: 'Time (ns)',
                        color: '#000000',
                        gridcolor: '#cccccc'
                    },
                    yaxis: {
                        title: 'Photon Count',
                        color: '#000000',
                        gridcolor: '#cccccc'
                    },
                    plot_bgcolor: '#ffffff',
                    paper_bgcolor: '#ffffff',
                    font: {color: '#000000'},
                    margin: {l: 50, r: 20, t: 40, b: 50}
                };
                
                Plotly.newPlot('pulse-plot', plotData, layout, {
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                    responsive: true
                });
                
                document.getElementById('pulse-loading').style.display = 'none';
                document.getElementById('pulse-plot').style.display = 'block';
                
                // Update populations
                document.getElementById('p-ms0').textContent = result.p_ms0.toFixed(3);
                document.getElementById('p-ms1').textContent = result.p_ms1.toFixed(3);
                
            } catch (error) {
                console.error('Error updating pulse plot:', error);
                document.getElementById('pulse-loading').innerHTML = '<p style="color: red;">Error loading plot</p>';
            }
        }

        // This function is only used in the Auswertung section for PODMR data
        async function showPulseDetail(pulseNumber) {
            // This function should only be called from the Auswertung section
            console.log('showPulseDetail called with pulse number:', pulseNumber);
            
            // For now, we'll just log it - this function is meant for PODMR pulse details
            // The actual pulse plotting in the simulator is handled by updatePulsePlot()
        }
        
        async function updateRabiPlot() {
            document.getElementById('rabi-loading').style.display = 'flex';
            document.getElementById('rabi-plot').style.display = 'none';
            
            try {
                // Use integration window for Rabi plot averaging
                const startTime = document.getElementById('start-time').value;
                const endTime = document.getElementById('end-time').value;
                
                const response = await fetch(`/api/rabi_plot?start=${startTime}&end=${endTime}&current_tau=${currentTau}`);
                const result = await response.json();
                
                // Create plot data
                const plotData = [{
                    x: result.tau_values,
                    y: result.p_ms0_values,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: {color: '#000000', width: 2},
                    marker: {color: '#000000', size: 3},
                    name: 'ms=0 Population'
                }, {
                    x: [currentTau, currentTau],
                    y: [0, 1],
                    type: 'scatter',
                    mode: 'lines',
                    line: {color: '#ff0000', width: 3, dash: 'dash'},
                    name: 'Current τ'
                }];
                
                const layout = {
                    title: {
                        text: `Rabi (${startTime}-${endTime}ns avg)`,
                        font: {color: '#000000', size: 14}
                    },
                    xaxis: {
                        title: 'MW Pulse Duration τ (ns)',
                        color: '#000000',
                        gridcolor: '#cccccc',
                        range: [0, 500]
                    },
                    yaxis: {
                        title: 'ms=0 Population',
                        color: '#000000',
                        gridcolor: '#cccccc',
                        range: [0, 1]
                    },
                    plot_bgcolor: '#ffffff',
                    paper_bgcolor: '#ffffff',
                    font: {color: '#000000'},
                    margin: {l: 50, r: 20, t: 40, b: 50}
                };
                
                Plotly.newPlot('rabi-plot', plotData, layout, {
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                    responsive: true
                });
                
                document.getElementById('rabi-loading').style.display = 'none';
                document.getElementById('rabi-plot').style.display = 'block';
                
            } catch (error) {
                console.error('Error updating Rabi plot:', error);
                document.getElementById('rabi-loading').innerHTML = '<p style="color: red;">Error loading plot</p>';
            }
        }
        
        async function updateEmissionSpectrum() {
            document.getElementById('spectrum-loading').style.display = 'flex';
            document.getElementById('spectrum-plot').style.display = 'none';
            
            try {
                const response = await fetch(`/api/emission_spectrum/${currentTau}`);
                const result = await response.json();
                
                // Create plot data for ZPL and PSB
                const plotData = [{
                    x: result.wavelengths_nm,
                    y: result.zpl_intensity,
                    type: 'scatter',
                    mode: 'lines',
                    line: {color: '#ff0000', width: 3},
                    name: 'Zero-Phonon Line (ZPL)',
                    fill: 'tozeroy',
                    fillcolor: 'rgba(255, 0, 0, 0.2)'
                }, {
                    x: result.wavelengths_nm,
                    y: result.psb_intensity,
                    type: 'scatter',
                    mode: 'lines',
                    line: {color: '#0000ff', width: 2},
                    name: 'Phonon Sideband (PSB)',
                    fill: 'tozeroy',
                    fillcolor: 'rgba(0, 0, 255, 0.1)'
                }];
                
                const layout = {
                    title: {
                        text: `NV Emission Spectrum (τ=${currentTau}ns, T=${physicsInfo.Temperature_K}K)`,
                        font: {color: '#000000', size: 14}
                    },
                    xaxis: {
                        title: 'Wavelength (nm)',
                        color: '#000000',
                        gridcolor: '#cccccc',
                        range: [630, 800]
                    },
                    yaxis: {
                        title: 'Normalized Intensity',
                        color: '#000000',
                        gridcolor: '#cccccc',
                        range: [0, 1.1]
                    },
                    plot_bgcolor: '#ffffff',
                    paper_bgcolor: '#ffffff',
                    font: {color: '#000000'},
                    margin: {l: 50, r: 20, t: 40, b: 50},
                    legend: {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255,255,255,0.8)',
                        bordercolor: '#000000',
                        borderwidth: 1
                    }
                };
                
                Plotly.newPlot('spectrum-plot', plotData, layout, {
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                    responsive: true
                });
                
                document.getElementById('spectrum-loading').style.display = 'none';
                document.getElementById('spectrum-plot').style.display = 'block';
                
            } catch (error) {
                console.error('Error updating emission spectrum:', error);
                document.getElementById('spectrum-loading').innerHTML = '<p style="color: red;">Error loading emission spectrum</p>';
            }
        }
        
        function prevTau() {
            const currentIndex = tauList.indexOf(currentTau);
            if (currentIndex > 0) {
                currentTau = tauList[currentIndex - 1];
                updateCurrentTau();
                if (isSimulated) updatePlots();
            }
        }
        
        function nextTau() {
            const currentIndex = tauList.indexOf(currentTau);
            if (currentIndex < tauList.length - 1) {
                currentTau = tauList[currentIndex + 1];
                updateCurrentTau();
                if (isSimulated) updatePlots();
            }
        }
        
        function jumpToAngle(targetAngle) {
            if (!physicsInfo.Omega_Rabi_Hz) return;
            
            const targetTau = targetAngle * Math.PI / (180 * physicsInfo.Omega_Rabi_Hz * 1e-9);
            const closestTau = tauList.reduce((prev, curr) => 
                Math.abs(curr - targetTau) < Math.abs(prev - targetTau) ? curr : prev
            );
            
            currentTau = closestTau;
            updateCurrentTau();
            if (isSimulated) updatePlots();
        }
        
        function resetTau() {
            currentTau = 0;
            updateCurrentTau();
            if (isSimulated) updatePlots();
        }
        
        // Auswertung functions
        let uploadedFiles = {};
        
        function toggleFileUpload() {
            const section = document.getElementById('file-upload-section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }
        
        async function loadSampleData() {
            // Show loading states
            document.getElementById('experimental-loading').style.display = 'flex';
            document.getElementById('experimental-plot').style.display = 'none';
            document.getElementById('experimental-rabi-loading').style.display = 'flex';
            document.getElementById('experimental-rabi-plot').style.display = 'none';
            document.getElementById('raw-loading').style.display = 'flex';
            document.getElementById('raw-plot').style.display = 'none';
            
            document.getElementById('experimental-loading').innerHTML = `
                <div class="loading-spinner"></div>
                <p>Lade Beispieldaten...</p>
            `;
            
            document.getElementById('raw-loading').innerHTML = `
                <div class="loading-spinner"></div>
                <p>Lade Raw-Daten...</p>
            `;
            
            try {
                // Load sample data from server
                const response = await fetch('/api/load_sample_data');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                // Parse the files
                const fileDataArray = [];
                for (const file of result.files) {
                    const parsedData = parseDataFile(file.content, file.filename);
                    fileDataArray.push(parsedData);
                }
                
                // Process and plot
                const experimentalData = processExperimentalData(fileDataArray);
                plotExperimentalData(experimentalData);
                plotExperimentalRabi(experimentalData);
                
            } catch (error) {
                console.error('Error loading sample data:', error);
                document.getElementById('experimental-loading').innerHTML = '<p style="color: red;">Fehler beim Laden der Beispieldaten: ' + error.message + '</p>';
                document.getElementById('experimental-rabi-loading').innerHTML = '<p style="color: red;">Fehler beim Laden der Beispieldaten</p>';
            }
        }
        
        async function loadSampleDataAutomatically() {
            console.log('Auto-loading PODMR data...');
            
            try {
                // Show loading states
                document.getElementById('experimental-loading').style.display = 'flex';
                document.getElementById('experimental-plot').style.display = 'none';
                
                // Directly call the functions to load PODMR data
                await updateAuswertungRabi();
                await loadPODMRPulseData();
                
                // Show overview info
                document.getElementById('experimental-loading').innerHTML = `
                    <h4>PODMR Daten geladen:</h4>
                    <p>✅ 50 Pulse aus PODMR-Messung</p>
                    <p>✅ Zeitfenster: 0-100ns</p>
                    <p>✅ Bin width: 3.2ns</p>
                `;
                document.getElementById('experimental-loading').style.display = 'block';
                document.getElementById('experimental-plot').style.display = 'none';
                
            } catch (error) {
                console.error('Error auto-loading PODMR data:', error);
            }
        }
        
        async function loadPODMRPulseData() {
            try {
                // Load some sample pulse data for display
                const pulses = [];
                for (let i = 0; i < 10; i++) {
                    const pulseResponse = await fetch(`/api/pulse_detail/${i}`);
                    const pulseData = await pulseResponse.json();
                    
                    if (!pulseData.error) {
                        pulses.push({
                            counts: pulseData.photon_counts,
                            time_ns: pulseData.time_points.map(t => t * 3.2), // Convert to actual ns
                            pulse_number: i + 1
                        });
                    }
                }
                
                // Set global variables for pulse navigation
                allPulses = pulses;
                currentPulseIndex = 0;
                
                // Show first pulse
                if (pulses.length > 0) {
                    updateSinglePulsePlot();
                }
                
                // Create raw plot
                plotRawPODMRData(pulses);
                
            } catch (error) {
                console.error('Error loading PODMR pulse data:', error);
            }
        }
        
        function plotRawPODMRData(pulses) {
            if (pulses.length === 0) {
                document.getElementById('raw-loading').innerHTML = '<p>Keine PODMR-Pulsdaten gefunden</p>';
                return;
            }
            
            // Create traces for all pulses
            const plotData = [];
            
            for (let i = 0; i < pulses.length; i++) {
                const pulse = pulses[i];
                plotData.push({
                    x: pulse.time_ns,
                    y: pulse.counts,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: `hsl(${(i * 360 / pulses.length)}, 70%, 50%)`,
                        width: 1
                    },
                    name: `Puls ${i + 1}`,
                    opacity: 0.7
                });
            }
            
            const layout = {
                title: {
                    text: `PODMR Pulse Data (${pulses.length} Pulse)`,
                    font: {color: '#000000', size: 16}
                },
                xaxis: {
                    title: 'Zeit (ns)',
                    color: '#000000',
                    gridcolor: '#cccccc'
                },
                yaxis: {
                    title: 'Counts',
                    color: '#000000',
                    gridcolor: '#cccccc'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff',
                font: {color: '#000000'},
                margin: {l: 60, r: 20, t: 60, b: 60},
                showlegend: true,
                legend: {
                    orientation: "h",
                    y: -0.2
                }
            };
            
            Plotly.newPlot('raw-plot', plotData, layout, {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                responsive: true
            });
            
            document.getElementById('raw-loading').style.display = 'none';
            document.getElementById('raw-plot').style.display = 'block';
        }
        
        
        async function updateAuswertungRabi() {
            // Get time window from auswertung controls with defaults
            const startTime = document.getElementById('auswertung-start-time') ? 
                document.getElementById('auswertung-start-time').value : 0;
            const endTime = document.getElementById('auswertung-end-time') ? 
                document.getElementById('auswertung-end-time').value : 100;
            
            try {
                document.getElementById('experimental-rabi-loading').style.display = 'flex';
                document.getElementById('experimental-rabi-plot').style.display = 'none';
                
                const response = await fetch(`/api/podmr_rabi_plot?start_time=${startTime}&end_time=${endTime}`);
                const result = await response.json();
                
                // Show connected line plot: each pulse gets its total counts in time window
                const plotData = [{
                    x: result.pulse_numbers,
                    y: result.pulse_totals,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: {color: '#000000', width: 2},
                    marker: {color: '#000000', size: 4},
                    name: `Total Counts pro Puls (${startTime}-${endTime}ns)`
                }];
                
                const layout = {
                    title: {
                        text: `PODMR Rabi Oszillation (${startTime}-${endTime}ns Zeitfenster)`,
                        font: {color: '#000000', size: 14}
                    },
                    xaxis: {
                        title: 'Pulse Number',
                        color: '#000000',
                        gridcolor: '#cccccc'
                    },
                    yaxis: {
                        title: `Total Photonen (${startTime}-${endTime}ns)`,
                        color: '#000000',
                        gridcolor: '#cccccc'
                    },
                    plot_bgcolor: '#ffffff',
                    paper_bgcolor: '#ffffff',
                    font: {color: '#000000'},
                    margin: {l: 50, r: 20, t: 40, b: 50},
                    annotations: [{
                        text: `Zeitfenster: ${startTime}-${endTime}ns<br>Mittlere Summe: ${result.mean_total.toFixed(0)}<br>Std: ${result.std_total.toFixed(0)}<br>Pulse: ${result.total_pulses}<br>Bin width: ${result.time_window.bin_width_ns.toFixed(2)}ns`,
                        x: 0.02,
                        y: 0.98,
                        xref: 'paper',
                        yref: 'paper',
                        bgcolor: 'rgba(255,255,255,0.8)',
                        bordercolor: '#000000',
                        borderwidth: 1,
                        showarrow: false
                    }]
                };
                
                Plotly.newPlot('experimental-rabi-plot', plotData, layout, {
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                    responsive: true
                });
                
                // Show the plot
                document.getElementById('experimental-rabi-loading').style.display = 'none';
                document.getElementById('experimental-rabi-plot').style.display = 'block';
                
            } catch (error) {
                console.error('Error plotting PODMR Rabi:', error);
                document.getElementById('experimental-rabi-loading').innerHTML = '<p style="color: red;">Error loading PODMR Rabi data</p>';
            }
        }
        
        async function uploadAndAnalyze() {
            const file1 = document.getElementById('file1').files[0];
            const file2 = document.getElementById('file2').files[0];
            const file3 = document.getElementById('file3').files[0];
            
            if (!file1 || !file2 || !file3) {
                alert('Bitte alle 3 Dateien hochladen!');
                return;
            }
            
            // Show loading states
            document.getElementById('experimental-loading').style.display = 'flex';
            document.getElementById('experimental-plot').style.display = 'none';
            document.getElementById('experimental-rabi-loading').style.display = 'flex';
            document.getElementById('experimental-rabi-plot').style.display = 'none';
            
            try {
                // Read and parse all files
                const fileData1 = await readAndParseFile(file1);
                const fileData2 = await readAndParseFile(file2);
                const fileData3 = await readAndParseFile(file3);
                
                // Extract experimental data
                const experimentalData = processExperimentalData([fileData1, fileData2, fileData3]);
                
                // Plot experimental data
                plotExperimentalData(experimentalData);
                
                // Generate Rabi oscillation plot
                plotExperimentalRabi(experimentalData);
                
            } catch (error) {
                console.error('Error processing files:', error);
                document.getElementById('experimental-loading').innerHTML = '<p style="color: red;">Fehler beim Verarbeiten der Dateien</p>';
                document.getElementById('experimental-rabi-loading').innerHTML = '<p style="color: red;">Fehler beim Verarbeiten der Dateien</p>';
            }
        }
        
        function readAndParseFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const parsedData = parseDataFile(content, file.name);
                        resolve(parsedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        function parseDataFile(content, filename) {
            const lines = content.split('\n');
            let dataStartIndex = -1;
            let metadata = {};
            
            // Find data start and extract metadata
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.includes('---- END HEADER ----')) {
                    dataStartIndex = i + 1;
                    break;
                }
                
                // Extract ALL metadata
                if (line.startsWith('# microwave_amplitude=')) {
                    metadata.mw_amplitude = parseFloat(line.split('=')[1]);
                }
                if (line.startsWith('# rabi_period=')) {
                    metadata.rabi_period = parseFloat(line.split('=')[1]);
                }
                if (line.startsWith('# bin width (s)=')) {
                    metadata.bin_width = parseFloat(line.split('=')[1]);
                }
                if (line.startsWith('# column_dtypes=')) {
                    metadata.column_dtypes = line.split('=')[1];
                }
                if (line.startsWith('# column_headers=')) {
                    metadata.column_headers = line.split('=')[1];
                }
            }
            
            if (dataStartIndex === -1) {
                console.log('No header end found, treating as raw data');
                dataStartIndex = 0;
            }
            
            // Auto-detect file type based on content structure
            let sampleDataLines = [];
            for (let i = dataStartIndex; i < Math.min(dataStartIndex + 20, lines.length); i++) {
                const line = lines[i].trim();
                if (line && !line.startsWith('#') && line.length > 0) {
                    sampleDataLines.push(line);
                }
            }
            
            console.log(`File ${filename}: Found ${sampleDataLines.length} data lines`);
            console.log(`Data starts at index: ${dataStartIndex}, total lines: ${lines.length}`);
            console.log(`Sample lines:`, sampleDataLines.slice(0, 3));
            
            if (sampleDataLines.length === 0) {
                return {
                    type: 'empty',
                    filename: filename,
                    metadata: metadata,
                    debug_info: `No data lines found after index ${dataStartIndex}, total lines: ${lines.length}`
                };
            }
            
            // Check if it's frequency sweep data (two columns with float values)
            const firstDataLine = sampleDataLines[0];
            const parts = firstDataLine.split('\t');
            
            console.log(`First line parts:`, parts);
            
            if (parts.length >= 2) {
                // Try to parse as two columns
                try {
                    const freq = parseFloat(parts[0]);
                    const signal = parseFloat(parts[1]);
                    
                    console.log(`Trying freq/signal: ${freq}, ${signal}`);
                    
                    if (!isNaN(freq) && !isNaN(signal) && freq > 1e6) { // Likely frequency data
                        // Parse as frequency sweep
                        const frequencies = [];
                        const signals = [];
                        
                        for (let i = dataStartIndex; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (line && !line.startsWith('#') && line.length > 0) {
                                const parts = line.split('\t');
                                if (parts.length >= 2) {
                                    const f = parseFloat(parts[0]);
                                    const s = parseFloat(parts[1]);
                                    if (!isNaN(f) && !isNaN(s)) {
                                        frequencies.push(f);
                                        signals.push(s);
                                    }
                                }
                            }
                        }
                        
                        console.log(`Found ${frequencies.length} frequency points`);
                        
                        return {
                            type: 'frequency_sweep',
                            frequencies: frequencies,
                            signals: signals,
                            metadata: metadata,
                            filename: filename
                        };
                    }
                } catch (e) {
                    console.log('Error parsing as frequency data:', e);
                }
            }
            
            // Check if it's pulse data (many integer counts in one or multiple columns)
            try {
                const values = firstDataLine.split('\t').map(v => parseInt(v.trim()));
                console.log(`Trying pulse data, first values:`, values.slice(0, 5));
                
                if (values.length > 0 && values.every(v => !isNaN(v) && v >= 0 && v < 10000)) { // Looks like count data
                    // Parse as INDIVIDUAL PULSES - each line is one pulse
                    const pulses = [];
                    
                    for (let i = dataStartIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line && !line.startsWith('#') && line.length > 0) {
                            const values = line.split('\t');
                            const pulseData = [];
                            
                            for (const val of values) {
                                const count = parseInt(val.trim());
                                if (!isNaN(count)) {
                                    pulseData.push(count);
                                }
                            }
                            
                            if (pulseData.length > 0) {
                                // Create time axis for this pulse
                                const timeAxis = pulseData.map((_, index) => index * (metadata.bin_width || 3.2e-9) * 1e9); // Convert to ns
                                
                                pulses.push({
                                    counts: pulseData,
                                    time_ns: timeAxis,
                                    pulse_number: pulses.length + 1
                                });
                            }
                        }
                    }
                    
                    console.log(`Found ${pulses.length} individual pulses`);
                    
                    return {
                        type: 'pulse_collection',
                        pulses: pulses,
                        metadata: metadata,
                        filename: filename
                    };
                }
            } catch (e) {
                console.log('Error parsing as pulse data:', e);
            }
            
            // Check if it's single column data (like raw_timetrace)
            if (parts.length === 1) {
                try {
                    const singleVal = parseInt(parts[0].trim());
                    if (!isNaN(singleVal) && singleVal >= 0) {
                        // Parse as single column data
                        const data = [];
                        
                        for (let i = dataStartIndex; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (line && !line.startsWith('#') && line.length > 0) {
                                const val = parseInt(line.trim());
                                if (!isNaN(val)) {
                                    data.push(val);
                                }
                            }
                        }
                        
                        console.log(`Found ${data.length} single column data points`);
                        
                        // Create time axis
                        const timeAxis = data.map((_, index) => index * (metadata.bin_width || 3.2e-9) * 1e9); // Convert to ns
                        
                        return {
                            type: 'pulse',
                            time_ns: timeAxis,
                            counts: data,
                            metadata: metadata,
                            filename: filename
                        };
                    }
                } catch (e) {
                    console.log('Error parsing as single column:', e);
                }
            }
            
            // Fallback: treat as raw data
            const allDataLines = [];
            for (let i = dataStartIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line && !line.startsWith('#')) {
                    allDataLines.push(line);
                }
            }
            
            return {
                type: 'raw',
                raw_data: allDataLines,
                metadata: metadata,
                filename: filename,
                sample_lines: sampleDataLines.slice(0, 5)
            };
        }
        
        // Global variables for pulse navigation
        let currentPulseIndex = 0;
        let allPulses = [];
        
        function processExperimentalData(fileDataArray) {
            // Log what we detected
            console.log('Detected file types:');
            fileDataArray.forEach(f => {
                console.log(`${f.filename}: ${f.type}`);
                if (f.type === 'raw') {
                    console.log('Sample data lines:', f.sample_lines);
                } else if (f.type === 'pulse_collection') {
                    console.log(`Pulse collection with ${f.pulses.length} pulses`);
                }
            });
            
            // Group files by type
            const pulseFiles = fileDataArray.filter(f => f.type === 'pulse');
            const pulseCollections = fileDataArray.filter(f => f.type === 'pulse_collection');
            const freqFiles = fileDataArray.filter(f => f.type === 'frequency_sweep');
            const rawFiles = fileDataArray.filter(f => f.type === 'raw');
            
            // Collect all individual pulses from pulse collections
            allPulses = [];
            pulseCollections.forEach(collection => {
                allPulses.push(...collection.pulses);
            });
            
            console.log(`Total individual pulses found: ${allPulses.length}`);
            
            // Reset pulse navigation
            currentPulseIndex = 0;
            
            return {
                pulse_files: pulseFiles,
                pulse_collections: pulseCollections,
                frequency_files: freqFiles,
                raw_files: rawFiles,
                all_pulses: allPulses,
                all_files: fileDataArray
            };
        }
        
        function prevPulse() {
            if (currentPulseIndex > 0) {
                currentPulseIndex--;
                updateSinglePulsePlot();
            }
        }
        
        function nextPulse() {
            if (currentPulseIndex < allPulses.length - 1) {
                currentPulseIndex++;
                updateSinglePulsePlot();
            }
        }
        
        function updateSinglePulsePlot() {
            if (allPulses.length === 0) return;
            
            const pulse = allPulses[currentPulseIndex];
            
            // Update counter
            document.getElementById('pulse-counter').textContent = `Puls ${currentPulseIndex + 1} / ${allPulses.length}`;
            
            const plotData = [{
                x: pulse.time_ns,
                y: pulse.counts,
                type: 'scatter',
                mode: 'lines',
                line: {color: '#000000', width: 2},
                name: `Puls ${pulse.pulse_number}`
            }];
            
            const layout = {
                title: {
                    text: `Einzelner Puls ${currentPulseIndex + 1}`,
                    font: {color: '#000000', size: 14}
                },
                xaxis: {
                    title: 'Zeit (ns)',
                    color: '#000000',
                    gridcolor: '#cccccc'
                },
                yaxis: {
                    title: 'Counts',
                    color: '#000000',
                    gridcolor: '#cccccc'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff',
                font: {color: '#000000'},
                margin: {l: 50, r: 20, t: 40, b: 50}
            };
            
            Plotly.newPlot('single-pulse-plot', plotData, layout, {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                responsive: true
            });
            
            document.getElementById('single-pulse-loading').style.display = 'none';
            document.getElementById('single-pulse-plot').style.display = 'block';
        }
        
        
        function plotExperimentalRabi(experimentalData) {
            // Always show some information about what we found
            let infoText = '<h4>Datenanalyse:</h4>';
            
            if (experimentalData.pulse_files.length > 1) {
                // We have multiple pulse files - try to create Rabi oscillation
                const amplitudes = experimentalData.rabi_data.map(d => d.amplitude);
                const meanCounts = experimentalData.rabi_data.map(d => d.mean_counts);
                
                if (meanCounts.length > 0 && meanCounts.every(c => !isNaN(c))) {
                    // Normalize data to 0-1 range for comparison with simulation
                    const maxCounts = Math.max(...meanCounts);
                    const minCounts = Math.min(...meanCounts);
                    const normalizedCounts = meanCounts.map(c => (maxCounts - minCounts) > 0 ? 
                        (c - minCounts) / (maxCounts - minCounts) : 0);
                    
                    const plotData = [{
                        x: amplitudes,
                        y: normalizedCounts,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: {color: '#000000', width: 2},
                        marker: {color: '#000000', size: 6},
                        name: 'Multi-File Rabi Analysis'
                    }];
                    
                    const layout = {
                        title: {
                            text: 'Rabi Analysis (Multiple Files)',
                            font: {color: '#000000', size: 14}
                        },
                        xaxis: {
                            title: 'File Index / Amplitude',
                            color: '#000000',
                            gridcolor: '#cccccc'
                        },
                        yaxis: {
                            title: 'Normalisierte Fluoreszenz',
                            color: '#000000',
                            gridcolor: '#cccccc',
                            range: [0, 1]
                        },
                        plot_bgcolor: '#ffffff',
                        paper_bgcolor: '#ffffff',
                        font: {color: '#000000'},
                        margin: {l: 50, r: 20, t: 40, b: 50}
                    };
                    
                    Plotly.newPlot('experimental-rabi-plot', plotData, layout, {
                        displayModeBar: true,
                        displaylogo: false,
                        modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                        responsive: true
                    });
                    
                    infoText += `<p>${experimentalData.pulse_files.length} Pulse-Dateien analysiert für Rabi-Oszillation</p>`;
                    document.getElementById('experimental-rabi-loading').innerHTML = infoText;
                    document.getElementById('experimental-rabi-loading').style.display = 'block';
                    document.getElementById('experimental-rabi-plot').style.display = 'block';
                    return;
                }
            }
            
            if (experimentalData.frequency_files.length > 0) {
                // Plot frequency sweep data as "Rabi" 
                const freqData = experimentalData.frequency_files[0];
                
                const plotData = [{
                    x: freqData.frequencies,
                    y: freqData.signals,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: {color: '#000000', width: 2},
                    marker: {color: '#000000', size: 4},
                    name: 'Frequency Sweep'
                }];
                
                const layout = {
                    title: {
                        text: 'Frequency Sweep Analysis',
                        font: {color: '#000000', size: 14}
                    },
                    xaxis: {
                        title: 'Frequenz (Hz)',
                        color: '#000000',
                        gridcolor: '#cccccc'
                    },
                    yaxis: {
                        title: 'Signal',
                        color: '#000000',
                        gridcolor: '#cccccc'
                    },
                    plot_bgcolor: '#ffffff',
                    paper_bgcolor: '#ffffff',
                    font: {color: '#000000'},
                    margin: {l: 50, r: 20, t: 40, b: 50}
                };
                
                Plotly.newPlot('experimental-rabi-plot', plotData, layout, {
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                    responsive: true
                });
                
                infoText += '<p>Frequency-Sweep als Rabi-ähnliche Analyse dargestellt</p>';
                document.getElementById('experimental-rabi-loading').innerHTML = infoText;
                document.getElementById('experimental-rabi-loading').style.display = 'block';
                document.getElementById('experimental-rabi-plot').style.display = 'block';
                return;
            }
            
            // Fallback: show what we have
            infoText += '<p>Für Rabi-Oszillation benötigt: mehrere Pulse-Dateien oder Frequency-Sweep-Daten</p>';
            infoText += `<p>Gefunden: ${experimentalData.pulse_files.length} Pulse-Dateien, ${experimentalData.frequency_files.length} Frequency-Dateien</p>`;
            
            document.getElementById('experimental-rabi-loading').innerHTML = infoText;
        }
        
        function plotExperimentalData(experimentalData) {
            // Show what files we have detected
            let infoText = '<h4>Erkannte Dateien:</h4><ul>';
            experimentalData.all_files.forEach(f => {
                infoText += `<li><strong>${f.filename}</strong>: ${f.type}`;
                if (f.type === 'pulse') {
                    infoText += ` (${f.counts.length} Datenpunkte)`;
                } else if (f.type === 'pulse_collection') {
                    infoText += ` (${f.pulses.length} Pulse)`;
                } else if (f.type === 'frequency_sweep') {
                    infoText += ` (${f.frequencies.length} Frequenzpunkte)`;
                } else if (f.type === 'raw') {
                    infoText += ` (${f.raw_data.length} Zeilen)`;
                }
                infoText += '</li>';
            });
            infoText += '</ul>';
            
            // Show overview plot based on what we have
            if (experimentalData.frequency_files.length > 0) {
                // Plot frequency data as overview
                const freqData = experimentalData.frequency_files[0];
                const plotData = [{
                    x: freqData.frequencies,
                    y: freqData.signals,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: {color: '#000000', width: 2},
                    marker: {color: '#000000', size: 4},
                    name: 'Frequency Sweep'
                }];
                
                const layout = {
                    title: {
                        text: `Übersicht: ${freqData.filename}`,
                        font: {color: '#000000', size: 14}
                    },
                    xaxis: {
                        title: 'Frequenz (Hz)',
                        color: '#000000',
                        gridcolor: '#cccccc'
                    },
                    yaxis: {
                        title: 'Signal',
                        color: '#000000',
                        gridcolor: '#cccccc'
                    },
                    plot_bgcolor: '#ffffff',
                    paper_bgcolor: '#ffffff',
                    font: {color: '#000000'},
                    margin: {l: 50, r: 20, t: 40, b: 50}
                };
                
                Plotly.newPlot('experimental-plot', plotData, layout, {
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                    responsive: true
                });
                
                document.getElementById('experimental-loading').innerHTML = infoText;
                document.getElementById('experimental-loading').style.display = 'block';
                document.getElementById('experimental-plot').style.display = 'block';
            } else {
                // Just show info if no frequency data available
                document.getElementById('experimental-loading').innerHTML = infoText;
            }
            
            // Initialize single pulse plot if we have pulses
            if (experimentalData.all_pulses.length > 0) {
                updateSinglePulsePlot();
            }
            
            // Create Raw plot with all pulse data
            plotRawData(experimentalData);
        }
        
        function plotRawData(experimentalData) {
            if (experimentalData.all_pulses.length === 0) {
                document.getElementById('raw-loading').innerHTML = '<p>Keine Pulsdaten für Raw-Ansicht gefunden</p>';
                return;
            }
            
            // Create traces for all pulses (show first 20 for performance)
            const maxPulsesToShow = Math.min(20, experimentalData.all_pulses.length);
            const plotData = [];
            
            for (let i = 0; i < maxPulsesToShow; i++) {
                const pulse = experimentalData.all_pulses[i];
                plotData.push({
                    x: pulse.time_ns,
                    y: pulse.counts,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: `hsl(${(i * 360 / maxPulsesToShow)}, 70%, 50%)`,
                        width: 1
                    },
                    name: `Puls ${i + 1}`,
                    opacity: 0.7
                });
            }
            
            const layout = {
                title: {
                    text: `Alle Pulse (zeige ersten ${maxPulsesToShow} von ${experimentalData.all_pulses.length})`,
                    font: {color: '#000000', size: 16}
                },
                xaxis: {
                    title: 'Zeit (ns)',
                    color: '#000000',
                    gridcolor: '#cccccc'
                },
                yaxis: {
                    title: 'Counts',
                    color: '#000000',
                    gridcolor: '#cccccc'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff',
                font: {color: '#000000'},
                margin: {l: 60, r: 20, t: 60, b: 60},
                showlegend: true,
                legend: {
                    orientation: "h",
                    y: -0.2
                }
            };
            
            Plotly.newPlot('raw-plot', plotData, layout, {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                responsive: true
            });
            
            document.getElementById('raw-loading').style.display = 'none';
            document.getElementById('raw-plot').style.display = 'block';
        }
        
    </script>
</body>
</html>